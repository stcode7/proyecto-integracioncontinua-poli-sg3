<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>ToDo List - Integración Continua</title>
    <style>
      .todo-item {
        transition: all 0.2s;
      }
      .todo-item:hover {
        background-color: #f8f9fa;
      }
      .done-true {
        text-decoration: line-through;
        color: #6c757d;
      }
    </style>
  </head>
  <body class="bg-light">
    
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow">
            <div class="card-header bg-primary text-white text-center py-3">
              <h2 class="mb-0"><i class="fas fa-check-double me-2"></i>Mi ToDo List</h2>
            </div>
            <div class="card-body">
              
              <!-- Input Form -->
              <div class="input-group mb-4">
                <input type="text" id="todoInput" class="form-control form-control-lg" placeholder="¿Qué necesitas hacer hoy?">
                <button class="btn btn-primary" type="button" onclick="addTodo()">
                  <i class="fas fa-plus"></i> Agregar
                </button>
              </div>

              <!-- List -->
              <ul class="list-group list-group-flush" id="todoList">
                <li class="list-group-item text-center text-muted">Cargando tareas...</li>
              </ul>

            </div>
            <div class="card-footer text-muted text-center small">
              Proyecto de Integración Continua
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      const API_URL = 'http://localhost:4567/todos'; // Confía en localhost porque el navegador corre en el host

      // Cargar tareas al inicio
      document.addEventListener('DOMContentLoaded', fetchTodos);

      // Permitir enter para agregar
      document.getElementById('todoInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') addTodo();
      });

      function fetchTodos() {
        fetch(API_URL)
          .then(res => res.json())
          .then(todos => renderTodos(todos))
          .catch(err => {
            console.error('Error fetching todos:', err);
            document.getElementById('todoList').innerHTML = '<li class="list-group-item text-danger text-center">Error al conectar con el backend. Asegúrate de que está corriendo.</li>';
          });
      }

      function renderTodos(todos) {
        const list = document.getElementById('todoList');
        list.innerHTML = '';

        if (todos.length === 0) {
          list.innerHTML = '<li class="list-group-item text-center text-muted">No tienes tareas pendientes. ¡Genial!</li>';
          return;
        }

        todos.forEach(todo => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center todo-item';
          
          li.innerHTML = `
            <div class="form-check flex-grow-1">
              <input class="form-check-input" type="checkbox" ${todo.done ? 'checked' : ''} onchange="toggleTodo(${todo.id}, this.checked)">
              <label class="form-check-label ms-2 ${todo.done ? 'done-true' : ''}">
                ${escapeHtml(todo.text)}
              </label>
            </div>
            <button class="btn btn-outline-danger btn-sm rounded-circle" onclick="deleteTodo(${todo.id})" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;
          list.appendChild(li);
        });
      }

      function addTodo() {
        const input = document.getElementById('todoInput');
        const text = input.value.trim();
        
        if (!text) return;

        fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        })
        .then(res => {
          if (!res.ok) throw new Error('Error adding todo');
          return res.json();
        })
        .then(() => {
          input.value = '';
          fetchTodos();
        })
        .catch(err => alert('Error agregando la tarea: ' + err.message));
      }

      function toggleTodo(id, done) {
        fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ done: done })
        })
        .then(res => {
          if (!res.ok) throw new Error('Error updating todo');
          fetchTodos();
        })
        .catch(err => console.error(err));
      }

      function deleteTodo(id) {
        if(!confirm('¿Estás seguro de eliminar esta tarea?')) return;

        fetch(`${API_URL}/${id}`, {
          method: 'DELETE'
        })
        .then(res => {
          if (!res.ok) throw new Error('Error deleting todo');
          fetchTodos();
        })
        .catch(err => console.error(err));
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
      }
    </script>
  </body>
</html>
